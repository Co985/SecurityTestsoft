<!doctype html>
<!-- edit-enabled-test: small harmless marker to confirm file edits are allowed -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D487 ‚Äì Certification-Style Software Security Exam (Practice + Exam)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --text:#e9eefc;
      --muted:#a7b3d8;
      --border:rgba(255,255,255,.12);
      --good:#25c46a;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --accent:#6aa6ff;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(106,166,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 100% 0%, rgba(37,196,106,.18), transparent 58%),
                  linear-gradient(180deg, #071025 0%, #070b16 100%);
      color: var(--text);
      min-height:100vh;
    }
    header{
      position: sticky; top:0; z-index: 10;
      backdrop-filter: blur(10px);
      background: rgba(7,16,37,.6);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px}
    .row{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(106,166,255,.95), rgba(37,196,106,.9));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{margin:0;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size:12px;color:var(--muted);
    }
    .pill strong{color:var(--text);font-weight:800}
    .btn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10);border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(106,166,255,.18); border-color: rgba(106,166,255,.45);}
    .btn.good{background: rgba(37,196,106,.16); border-color: rgba(37,196,106,.45)}
    .btn.danger{background: rgba(255,77,109,.15); border-color: rgba(255,77,109,.45)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    main .wrap{padding-top:18px;padding-bottom:42px}
    .grid{display:grid;grid-template-columns: 340px 1fr;gap:16px;align-items:start;}
    @media (max-width: 980px){.grid{grid-template-columns: 1fr}}

    .card{
      background: rgba(17,26,46,.72);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .bd{padding:14px}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    .select, .input{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(7,16,37,.5);
      color: var(--text);
      outline:none;
    }
    .select:focus, .input:focus{border-color: rgba(106,166,255,.55)}
    .settings{display:grid;gap:10px;}

    .toggleRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:10px 12px;border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .switch{
      width:48px;height:28px;border-radius:999px;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;top:3px;left:3px;
      width:22px;height:22px;border-radius:50%;
      background: rgba(255,255,255,.78);
      transition: left .15s ease, background .15s ease;
    }
    .switch.on{background: rgba(37,196,106,.18); border-color: rgba(37,196,106,.45)}
    .switch.on::after{left:23px;background: rgba(37,196,106,.95)}

    .kpi{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    .kpi .box{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding:10px;
    }
    .kpi .box .t{font-size:11px;color:var(--muted);margin-bottom:4px}
    .kpi .box .v{font-size:14px;font-weight:900}

    .navGrid{display:grid;grid-template-columns: repeat(10, 1fr);gap:6px;}
    @media (max-width: 980px){ .navGrid{grid-template-columns: repeat(12, 1fr);} }

    .navBtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 10px;
      padding:8px 0;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      position:relative;
    }
    .navBtn:hover{background: rgba(255,255,255,.10)}
    .navBtn.active{outline: 2px solid rgba(106,166,255,.6)}
    .navBtn.locked{border-color: rgba(37,196,106,.70);background: rgba(37,196,106,.10);}
    .navBtn.tried{border-color: rgba(255,176,32,.75);background: rgba(255,176,32,.08);}
    .navBtn.answered{border-color: rgba(106,166,255,.55);}
    .navBtn.unanswered{opacity:.85;}
    .navBtn.flagged::after{
      content:"üö©";
      position:absolute;
      top:-4px;
      right:-4px;
      font-size:12px;
    }

    .qMeta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color: var(--muted);font-size:12px;margin-bottom: 10px;}
    .tag{
      padding:4px 8px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight:800;
      font-size:11px;
    }
    .stem{font-size:16px;line-height:1.35;margin: 6px 0 12px;}
    .choice{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      margin-bottom:10px;
      transition: background .12s ease, border-color .12s ease, transform .05s ease;
    }
    .choice:hover{background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .choice:active{transform: translateY(1px)}
    .choice.disabled{opacity:.6;cursor:not-allowed}
    .choice.triedWrong{border-color: rgba(255,176,32,.75);background: rgba(255,176,32,.06);}
    .choice.correct{border-color: rgba(37,196,106,.75);background: rgba(37,196,106,.10);}
    .choice.selected{outline: 2px solid rgba(106,166,255,.55);}
    .bullet{
      width:26px;height:26px;border-radius: 10px;
      background: rgba(106,166,255,.16);
      border:1px solid rgba(106,166,255,.35);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .choice .txt{flex:1 1 auto}
    .choice .txt .main{font-weight:900}

    .feedback{
      margin-top: 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      padding: 12px;
      line-height:1.35;
      display:none;
    }
    .feedback.show{display:block}
    .feedback.good{border-color: rgba(37,196,106,.55);background: rgba(37,196,106,.12);}
    .feedback.warn{border-color: rgba(255,176,32,.65);background: rgba(255,176,32,.10);}
    .feedback h3{margin:0 0 6px;font-size:13px}
    .feedback p{margin:0;color:var(--text)}
    .feedback .mini{margin-top:8px;color:var(--muted);font-size:12px}

    .footerBar{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;flex-wrap:wrap;margin-top: 14px;
      padding-top: 12px;border-top: 1px solid var(--border);
    }
    .progressRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .bar{
      width:220px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;border:1px solid var(--border);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(106,166,255,.95), rgba(37,196,106,.95));
    }
    .hr{height:1px;background: var(--border);margin:12px 0}

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:100;
      padding:18px;
    }
    .modalBackdrop.show{display:flex;align-items:center;justify-content:center}
    .modal{
      width:min(820px, 98vw);
      background: rgba(17,26,46,.95);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal .hd h2{margin:0;font-size:14px}
    .modal .bd{padding:14px 16px;max-height: 78vh; overflow:auto}

    .attemptCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:12px;
      margin-bottom: 12px;
    }
    .attemptCard .top{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .attemptCard .top .title{font-weight:900}
    .attemptCard .meta{color:var(--muted);font-size:12px}
    .twoCol{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 800px){.twoCol{grid-template-columns: 1fr}}
    .list{margin: 8px 0 0;padding-left: 18px;color: var(--text);}
    .list li{margin: 6px 0}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>D487 ‚Äì Certification-Style Software Security Exam</h1>
          <p class="sub">Scenario-based ‚Ä¢ 100 Q/attempt ‚Ä¢ Autosave/Resume ‚Ä¢ Detailed teaching feedback (Practice)</p>
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div class="pill" id="modePill">Mode: <strong>‚Äî</strong></div>
        <div class="pill" id="timerPill">Time: <strong>‚Äî</strong></div>
        <button class="btn" id="btnAttempts">Attempts</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <h2>Setup</h2>
          <span class="tag" id="resumeTag" style="display:none;">Resume available</span>
        </div>
        <div class="bd">
          <div class="settings">
            <div>
              <div class="small muted" style="margin-bottom:6px;">Mode</div>
              <select class="select" id="modeSelect">
                <option value="practice">Practice (teaching feedback + lock when correct)</option>
                <option value="exam">Exam (90 min, report on submit)</option>
              </select>
            </div>

            <div class="toggleRow">
              <div>
                <div style="font-weight:900;">Timed</div>
                <div class="small muted">Exam defaults to 90 minutes. Practice is untimed.</div>
              </div>
              <div class="switch" id="timedSwitch" role="switch" aria-checked="false"></div>
            </div>

            <div id="durationRow" style="display:none;">
              <div class="small muted" style="margin-bottom:6px;">Duration (minutes)</div>
              <input class="input" id="durationInput" type="number" min="1" max="240" value="90"/>
              <div class="small muted" style="margin-top:6px;">
                Idle pause occurs after <strong>10 minutes</strong> without activity (saves and stops timer).
              </div>
            </div>

            <div class="hr"></div>

            <button class="btn primary" id="btnStart">Start new attempt (100 questions)</button>
            <button class="btn good" id="btnResume" style="display:none;">Resume saved attempt</button>

            <div class="hr"></div>

            <div class="kpi">
              <div class="box">
                <div class="t">Progress</div>
                <div class="v" id="kpiProgress">0 / 100</div>
              </div>
              <div class="box">
                <div class="t">Locked (Practice)</div>
                <div class="v" id="kpiLocked">0</div>
              </div>
              <div class="box">
                <div class="t">Answered</div>
                <div class="v" id="kpiAnswered">0</div>
              </div>
              <div class="box">
                <div class="t">Tried (wrong)</div>
                <div class="v" id="kpiTried">0</div>
              </div>
              <div class="box">
                <div class="t">Flagged</div>
                <div class="v" id="kpiFlagged">0</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="small muted" style="margin-bottom:8px;">Question Navigation</div>
            <div class="navGrid" id="navGrid"></div>

            <div class="hr"></div>

            <div class="row" style="justify-content:space-between">
              <button class="btn" id="btnPrev">‚óÄ Prev</button>
              <button class="btn" id="btnNext">Next ‚ñ∂</button>
            </div>

            <div class="row" style="justify-content:space-between;margin-top:10px">
              <button class="btn danger" id="btnSubmit">Submit attempt</button>
              <button class="btn" id="btnSave">Save</button>
            </div>

            <div class="small muted" style="margin-top:10px;">
              Practice mode rules: wrong = explain why your selected option is wrong (no correct reveal) + try again. Correct = green teaching explanation + lock only that question.
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <h2 id="qTitle">Question</h2>
          <div style="display:flex;gap:8px;align-items:center;">
            <span class="tag" id="qStatusTag">‚Äî</span>
            <button class="btn" id="btnFlag" style="padding:6px 10px;font-size:11px;" title="Flag this question">üö© Flag</button>
          </div>
        </div>
        <div class="bd">
          <div class="qMeta">
            <span class="tag" id="qNumberTag">#‚Äî</span>
            <span class="tag" id="qCategoryTag">‚Äî</span>
            <span class="tag" id="qTypeTag">‚Äî</span>
          </div>

          <div class="stem" id="qStem">Click ‚ÄúStart new attempt‚Äù.</div>
          <div id="choices"></div>

          <div class="feedback" id="feedbackBox">
            <h3 id="feedbackTitle">Feedback</h3>
            <p id="feedbackText"></p>
            <div class="mini" id="feedbackMini"></div>
          </div>

          <div class="footerBar">
            <div class="progressRow">
              <div class="bar"><div id="progressBar"></div></div>
              <div class="small muted" id="progressText">0% complete</div>
            </div>
            <div class="row" style="gap:10px">
              <button class="btn" id="btnPause">Pause</button>
              <button class="btn good" id="btnResumeTimer" style="display:none;">Resume timer</button>
            </div>
          </div>

          <div class="small muted" style="margin-top:10px;">
            Exam mode: no teaching feedback during the test; full strengths/weaknesses report after submit.
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div class="hd">
      <h2 id="modalTitle">Modal</h2>
      <button class="btn" id="modalClose">Close</button>
    </div>
    <div class="bd" id="modalBody"></div>
  </div>
</div>

<script>
/* =========================================================
   STORAGE + CONSTANTS
   ========================================================= */
const LS = {
  ACTIVE: "d487_active_attempt_cert_v1",
  ATTEMPTS: "d487_attempt_history_cert_v1"
};
const QUESTION_COUNT = 100;
const IDLE_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes
const AUTO_SAVE_MS = 10 * 1000;

/* =========================================================
   UTIL
   ========================================================= */
function safeParse(json, fallback){ try { return JSON.parse(json); } catch { return fallback; } }
function nowISO(){ return new Date().toISOString(); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmtTime(ms){
  if(ms == null) return "‚Äî";
  const s = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(s/60);
  const r = s%60;
  return `${m}:${String(r).padStart(2,"0")}`;
}
function mulberry32(seed){
  let a = seed >>> 0;
  return function(){
    a |= 0;
    a = (a + 0x6D2B79F5) | 0;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function shuffle(arr, rng){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function unique(arr){
  const seen = new Set();
  const out = [];
  for(const x of arr){
    const key = String(x).trim();
    if(!key) continue;
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }
  return out;
}
function simpleHash(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0).toString(16);
}
function $(id){ return document.getElementById(id); }

/* =========================================================
   CONTENT BANK (extracted from your Matrix + Roles docs)
   - This is intentionally large so each attempt can be unique.
   ========================================================= */
const TERMS = [
  {term:"Abstract Syntax Tree",definition:"The structure of the code that represents source code in a tree format.",usage:"Used to detect, analyze, and understand software issues in code or software."},
  {term:"Active Scanner",definition:"Network and web app scanning that probes to test inputs to find exploits.",usage:"Send test inputs to find exploits and security vulnerabilities."},
  {term:"Agile Methodology",definition:"Small steps adapting to issues as they become apparent with iterative development cycles.",usage:"An adaptive way to approach exploits and fix them; allows product release after each iteration unlike waterfall. Provides customer satisfaction and continuous delivery."},
  {term:"Alpha Level Testing",definition:"Testing before product release focusing on functionality, security, and performance.",usage:"Identify basic functionality issues and security vulnerabilities early."},
  {term:"Application Decomposition",definition:"Breaking down an app into logical parts to understand security risks.",usage:"Identify attack surfaces, trust boundaries, and vulnerabilities before attackers find them."},
  {term:"Application Security",definition:"Protecting software from security threats through methods and tools.",usage:"Prevent, detect, and prevent vulnerabilities in applications."},
  {term:"Application-Centric Threat Modeling",definition:"Analyzing app architecture, data flows, and trust boundaries to find controls to fix threats.",usage:"Apply STRIDE to list threats for each element and identify realistic threats per component."},
  {term:"AppSec",definition:"Protecting apps from threats by focusing on code, logic, APIs, and data.",usage:"Address security at the application level throughout development."},
  {term:"Architecture (A2) Phase",definition:"Look at security as it relates to business risks and CIA triad.",usage:"Examine business requirements including how they affect CIA and privacy controls for PII."},
  {term:"Asset-Centric Threat Modeling",definition:"Threat models focused on protecting assets identified by senior management.",usage:"Make a list of assets to know what to protect and check each element for threats."},
  {term:"Authenticated Scans",definition:"Require software to log onto a system to scan for vulnerabilities.",usage:"Identify issues for both external and internal scans and reduce false positives."},
  {term:"Benchmarks",definition:"Tests used to compare estimates to actual results.",usage:"Confirm that risk analysis is accurate for systems and software."},
  {term:"Beta Level Testing",definition:"Testing after product release focusing on usability and edge cases.",usage:"Identify unexpected issues in real-world conditions."},
  {term:"Black Box Testing",definition:"Blind testing where the tester knows nothing about the infrastructure.",usage:"Test the security of software externally without internal knowledge."},
  {term:"Building Security In Maturity Model (BSIMM)",definition:"A study of real-world software security practices allowing development over time.",usage:"Get a clear picture of your security posture and plan how to develop it."},
  {term:"Code Review",definition:"Identify insecure code and security vulnerabilities during development.",usage:"Find risks early to avoid later problems; make it a practice to review code during development."},
  {term:"Common Vulnerabilities and Exposures (CVE)",definition:"Provides common names to vulnerabilities for consistent reference.",usage:"Make vulnerability data available across different tools and repositories."},
  {term:"Common Vulnerability Scoring System (CVSS)",definition:"The score for how severe a vulnerability is ranked from low to critical.",usage:"Communicate vulnerability severity consistently to prioritize remediation."},
  {term:"Construction",definition:"Define goals and create software within development projects.",usage:"Part of OpenSAMM; examine software security practices including threat assessment and secure architecture."},
  {term:"Control Flow Analysis",definition:"Step through logical conditions in the code.",usage:"Help find security issues within the code for coding vulnerabilities."},
  {term:"Data Flow Analysis",definition:"Trace data from points of input to points of output.",usage:"Used during code review and correlates with data flow diagrams during threat modeling."},
  {term:"Data Flow Diagrams (DFD)",definition:"Communicate how systems work and analyze apps showing architectural overview.",usage:"Used for threat modeling methodologies to examine problems with data flow; can apply STRIDE to elements."},
  {term:"Denial of Service",definition:"Authorized users denied access to resources impacting availability.",usage:"A categorization of threats using STRIDE to mitigate risks."},
  {term:"Deployment Phase",definition:"Deploy the product and push it out to users.",usage:"Determine what is stored and how the product is distributed securely."},
  {term:"Design and Development (A3) Phase",definition:"Examine and test software to address security and privacy issues as you progress.",usage:"Design security analysis and review with static analysis and secure coding practices."},
  {term:"Design and Development (A4) Phase",definition:"Readiness phase continuing security testing and policy compliance analysis.",usage:"Identify security issues missed in A3 through continued testing and code review."},
  {term:"Design Phase",definition:"Technical and business requirements describing how the app should be written.",usage:"Identify threats and controls; implement secure coding practices and risk analysis."},
  {term:"Design Review",definition:"Inspecting artifacts created from the design process.",usage:"Improve design principles and reduce the impact of security issues within the code."},
  {term:"Digital Enterprise",definition:"Used to enable and improve business activities using Agile, DevOps, and cloud.",usage:"Evaluate business needs to increase security operations."},
  {term:"DREAD",definition:"Risk rating system based on Damage potential, Reproducibility, Exploitability, Affected Users, and Discoverability.",usage:"Construct a document with all threats for threat modeling using scores 1-3."},
  {term:"Dynamic Analysis",definition:"Executing programs on a real or virtual processor in real time.",usage:"Monitor system memory, functional behaviors, response times, and performance."},
  {term:"Elevation of Privilege",definition:"Having elevated access when you should not have it.",usage:"Counteract by enforcing principle of least privilege with read-only access."},
  {term:"End of Life Phase",definition:"Software that is no longer useful requiring decommission.",usage:"Evaluate how it affects the backend and turn everything off; document everything."},
  {term:"Environment Hardening",definition:"Controls of the operating environment of a software.",usage:"Adjust the environment to SDL to fit maturity models during security requirements."},
  {term:"Exploratory Tests",definition:"Assess the quality of work and find issues not covered by scripted tests.",usage:"Provide valuable feedback about system behavior and security posture."},
  {term:"External Resources",definition:"Temp hired resources that test apps and report findings.",usage:"Highly skilled security testing professionals hired for projects to test applications."},
  {term:"External Scans",definition:"Scans targeting security issues found outside the firewall.",usage:"Available to attackers but help find security risks."},
  {term:"Extreme Programming",definition:"Improve software quality and responsiveness through agile practices.",usage:"Make good reliable code using continuous testing and integration."},
  {term:"Functional Requirements",definition:"What the software will do and its purpose.",usage:"Compare software security requirements to functional testing for compliance."},
  {term:"Functional Testing Scripts",definition:"Specific scenario or situation instructions to test if software requirements are in place.",usage:"Test the security of the application."},
  {term:"Fuzz Testing",definition:"Randomized data for security-related testing which can be automated or semi-automated.",usage:"Test software for bugs and vulnerabilities; emulate how attackers might exploit software."},
  {term:"Governance",definition:"How to manage overall software development activities and compliance.",usage:"ID compliance controls, develop SLA, focus on policy compliance, training, and auditing."},
  {term:"Gray Box Testing",definition:"Analyze code to help design test cases and evaluate code execution.",usage:"Locate vulnerabilities through dynamic code execution while the app is running."},
  {term:"Hardware",definition:"Anything you can touch on a computer and hardware requirements for a project.",usage:"Security examines hardware for security flaws during dynamic analysis."},
  {term:"Implementation Phase",definition:"Development phase testing the code and examine all the resources.",usage:"Conduct security testing of the code and code review."},
  {term:"Information Disclosure",definition:"Read a file that one was not allowed to access.",usage:"A threat categorization that affects confidentiality through STRIDE."},
  {term:"Internal Resources",definition:"Tools, software, developers, and project managers from within the company.",usage:"Check resources during Design and Development stage for test planning."},
  {term:"Internal Scans",definition:"Scans to identify security issues from inside the company that can be internally exploited.",usage:"Scan inside the firewall to ID security issues in case of internal attack."},
  {term:"Intrusive Target Search",definition:"Exploit a vulnerability when identified during scans and interact with the client.",usage:"Find systems and vulnerabilities; use ICMP or TCP to ping systems."},
  {term:"Legacy Code",definition:"Outdated code that often introduces security risks needing addressing.",usage:"Test and review for mitigation; perform security assessment."},
  {term:"Maintenance Phase",definition:"Ongoing security monitoring after product release.",usage:"Patch development, patch management, and incident response procedures."},
  {term:"Measurement Model",definition:"Data security methods to protect against vulnerabilities using CVSS and NVD.",usage:"Measure vulnerability using environmental scores, base scores, and temporal scores."},
  {term:"Merger and Acquisition",definition:"When companies consolidate and must assess business and security risks.",usage:"Identify security risks and deal breakers from consolidation."},
  {term:"Metric Model",definition:"Determine the effectiveness of security controls using NVD and SCAP.",usage:"Automate vulnerability management, security measurement, and compliance."},
  {term:"National Institute of Standards and Technology (NIST)",definition:"Federal standard research providing info and tools for government and corporate security.",usage:"Suggests integrating security best practices into the SDLC as a security reference."},
  {term:"Nmap",definition:"Network scanning tool and security auditing tool.",usage:"Audit open ports in a subnet for security assessments."},
  {term:"Non-Functional Requirements",definition:"Describes requirements or restrictions on design that do not impact the purpose.",usage:"Check for vulnerabilities during test planning and evaluate security behaviors."},
  {term:"NVD Database",definition:"National Vulnerability Database is a US government archive of vulnerability standards.",usage:"Communicate risks of IT vulnerabilities and used as security checklist using CVSS."},
  {term:"Open Software Assurance Maturity Model (OpenSAMM)",definition:"Implement software security that targets company needs with flexible activities.",usage:"Review software security practices and determine maturity of security program."},
  {term:"Open-Source Security Testing Methodology Manual (OSSTMM)",definition:"Templates and standards when developing testing techniques with focus on operational security.",usage:"Covers human security, facilities, access control; used during testing and pen-testing."},
  {term:"Open Web Application Security Project (OWASP)",definition:"Flexible framework to build security into software development organization.",usage:"Define security requirements, audits, assessments, and training; find vulnerabilities before release."},
  {term:"Open-Source Software License Compliance",definition:"Compliance for in-house software licensing.",usage:"Ensure compliance to avoid legality proceedings and delays in product release."},
  {term:"Open-Source Software Security",definition:"Identify security issues within in-house developed software.",usage:"Teams check open-source software code and identify and mitigate issues."},
  {term:"Operational Enablement",definition:"Identifying and capturing security information during deployment.",usage:"Properly configure, deploy, and run software during deployment phase."},
  {term:"OWASP Zed Attack Proxy (ZAP)",definition:"Open source tool used by security developers to find many vulnerabilities.",usage:"Find vulnerabilities like XSS, SQL injection, CSRF; used for testing and training."},
  {term:"Passive Scanner",definition:"Silent analysis of HTTP requests and responses without sending malicious payloads.",usage:"Detect issues without modifying traffic; can be used in production."},
  {term:"PASTA",definition:"Process for Attack Simulation and Threat Analysis with repeatable framework.",usage:"Evaluate threats to the system using business objectives and tech scope."},
  {term:"Penetration Testing",definition:"Authorized attack to identify weaknesses using manual and automated review.",usage:"Analyze data flow, control flow, coding practices for vulnerabilities."},
  {term:"Planning Phase",definition:"Make a blueprint defining the problem, scope, and objectives of new systems.",usage:"Gather security tools needed for analysis and establish ultimate goals."},
  {term:"Policy and Compliance",definition:"Practice of governance involving setting up security and compliance control.",usage:"Define mandatory controls, standards, and security requirements throughout SDL and SDLC."},
  {term:"Post-Release Support Phase",definition:"Prepare for vulnerabilities after product release including patching and incident response.",usage:"Monitor, manage, and remediate security vulnerabilities discovered after release."},
  {term:"Privacy Impact Assessment",definition:"Analyze privacy impact rating of PII and evaluate privacy and data-protection risks.",usage:"Identify privacy risks early during requirements and design phases."},
  {term:"Product Risk Profile",definition:"Cost of the product and security risk level based on data type and exposure.",usage:"Determine how rigorous security controls and testing must be throughout development."},
  {term:"Product Security Incident Response Team (PSIRT)",definition:"Receives, investigates, and reports security vulnerabilities and manages disclosures.",usage:"Manage security incidents responsibly and coordinate fixes."},
  {term:"Pull Request",definition:"Merge code into another branch with code review before integration.",usage:"Identify vulnerabilities before merging and enforce coding standards."},
  {term:"Repudiation",definition:"Users cannot deny having performed an action; requires strong authentication.",usage:"Prevent through strong authentication, secure logging, and cryptographic mechanisms."},
  {term:"Requirement Phase",definition:"Review all security requirements for the software and create specifications.",usage:"Define what coding language, hardware requirements, and data storage will be used."},
  {term:"Requirement Traceability Matrix",definition:"Lists all security requirements mapped to design, code, and test cases.",usage:"Ensure every security requirement is mapped and no requirement is overlooked."},
  {term:"Risk Model",definition:"Assess vulnerabilities during development by identifying threats and impact.",usage:"Identify threats and vulnerabilities to prioritize security controls."},
  {term:"Scripts",definition:"Instructions on what to do during testing and automate security tasks.",usage:"Test the security of the app and automate development and deployment."},
  {term:"Scrum",definition:"Work as a unit in sprints to meet goals with product owners and scrum masters.",usage:"Manage and collaborate on products breaking down projects into sprints."},
  {term:"Secure Architecture",definition:"Structural design of a system with security controls like authentication flows.",usage:"Ensure security is built into the system rather than added later."},
  {term:"Secure Code",definition:"Code aligned with security best practices and protecting against known vulnerabilities.",usage:"Reduce the likelihood of exploitable defects in production."},
  {term:"Secure Testing Scripts",definition:"Scripts for apps being tested to automate security validation.",usage:"Ensure consistent and repeatable security testing."},
  {term:"Security Assessment (A1) Phase",definition:"Product risks are evaluated and a plan is made to coincide with mitigation.",usage:"Make sure software solutions address security threats through mitigation."},
  {term:"Security Development Lifecycle (SDL)",definition:"Roadmap for implementation ensuring software is secure and adheres to CIA.",usage:"Reduce vulnerabilities and address privacy issues throughout development."},
  {term:"Security Requirements",definition:"Promotion of security inclusion during development specifying assets and controls.",usage:"Establish consistent security expectations across projects."},
  {term:"Security Testing",definition:"Evaluates application resilience against threats through static and dynamic testing.",usage:"Validate that implemented controls work as intended."},
  {term:"Ship (A5) Phase",definition:"Verifies product compliance before release and establishes post-release processes.",usage:"Review compliance requirements and establish processes for patching and incident response."},
  {term:"Software Development Lifecycle (SDLC)",definition:"Structured framework for embedding security throughout software creation.",usage:"Provides framework aligned with SDL to ensure security at every stage."},
  {term:"Software Security Champion (SSC)",definition:"Advocate for security that promotes awareness in the development team.",usage:"Help with understanding risks and best practices; bridge between security and developers."},
  {term:"Software Security Policy",definition:"What needs protecting and how; provides guidance for developers and testers.",usage:"Ensure compliance throughout development and maintenance."},
  {term:"SonarQube",definition:"Source code analysis detecting code smells, vulnerabilities, and hotspots.",usage:"Help developers detect issues before release and improve code quality."},
  {term:"Spider",definition:"Automatically discovers application pages and inputs for security scanning.",usage:"Identify the attack surface by discovering application structure."},
  {term:"Spoofing",definition:"Taking someone's credentials requiring strong authentication and identity validation.",usage:"Prevent through strong authentication mechanisms and identity validation."},
  {term:"SQL Injection",definition:"Malicious code exploiting unsanitized input to manipulate databases.",usage:"Prevent through input validation and secure query handling."},
  {term:"Static Analysis",definition:"Analysis without executing programs performed against app code or source code.",usage:"Look for unsanitized inputs and ID common coding defects."},
  {term:"Strategy and Metrics",definition:"Software assurance and processes to collect metrics on security.",usage:"Define security goals and measure effectiveness of security practices."},
  {term:"STRIDE",definition:"Spoofing, Tampering, Repudiation, Info Disclosure, Denial of Service, Elevation of Privilege.",usage:"Categorization of attacks to correctly reduce risks through threat modeling."},
  {term:"System Test",definition:"Test the interaction with other systems and identify security weaknesses.",usage:"Evaluate how components interact across integrated systems."},
  {term:"Tampering",definition:"Modifying or changing data for malicious reasons.",usage:"Protect through integrity checks and access controls."},
  {term:"Target Machine",definition:"Practice identifying attack surfaces and vulnerabilities.",usage:"Used to practice identifying vulnerabilities and simulating attacks."},
  {term:"Testing Phase",definition:"Discoveries from implementation run through test results.",usage:"Look at infra as attacker; discover potential targets and vulnerabilities."},
  {term:"Third Party Codes",definition:"Reusable externally developed software introducing external risks.",usage:"Manage vulnerabilities in dependencies that affect the entire system."},
  {term:"Threat Assessment (TA)",definition:"Identify and characterize potential threats to help prioritize mitigations.",usage:"Evaluate potential security threats early in development."},
  {term:"Threat Modeling",definition:"Find vulnerabilities using abuse cases and risk reduction as main goal.",usage:"Build security monitoring and detection; perform proactively during requirement and design phases."},
  {term:"Threat Profile",definition:"Threats specific to the product environment.",usage:"Understand risk context and inform requirements and design decisions."},
  {term:"Threat Source",definition:"Entity doing the attack and who or what may attack the system.",usage:"Identify threat sources early in security assessment."},
  {term:"Threat Vector",definition:"Means to exploit a vulnerability describing the path attackers use.",usage:"Understand how attacks occur and control entry points."},
  {term:"Trike",definition:"Conceptual framework for security auditing using asset-centric approach.",usage:"Define how to protect and defend assets through automated threat generation."},
  {term:"Verification",definition:"OpenSAMM checks and test artifacts including design review and code review.",usage:"Inspect artifacts for security and conduct testing to seek vulnerabilities."},
  {term:"Virtualization",definition:"Technology used to isolate applications and environments to reduce risk.",usage:"Support secure deployment and testing with isolation."},
  {term:"V-Model",definition:"Waterfall turned back upwards ensuring testing corresponds to development.",usage:"Ensure security requirements are validated through matching tests."},
  {term:"Vulnerability",definition:"A weakness that attackers can exploit requiring identification and fixing.",usage:"Fix vulnerabilities to reduce risk exposure."},
  {term:"Vulnerability Assessments",definition:"Systematically identify weaknesses and provide insight into security posture.",usage:"Guide remediation efforts through comprehensive evaluation."},
  {term:"Vulnerability Management (VM)",definition:"Manage internal and external vulnerability reports to limit exposure.",usage:"Consistently manage reports and enhance security assurance program."},
  {term:"Vulnerability Scan",definition:"Tools used to scan for vulnerabilities providing consistent results.",usage:"Detect known weaknesses to support continuous security improvement."},
  {term:"Vulnerability Sites",definition:"Sites that provide up-to-date information on security flaws.",usage:"Help teams stay aware of emerging risks and support timely patching."},
  {term:"Waterfall Methodology",definition:"Sequential process for requirements used for small projects with defined requirements.",usage:"Emphasize security planning in early stages with formal sequence."},
  {term:"White Box Testing",definition:"Tester knows about the code examining internal code and logic.",usage:"Allow deep analysis of security weaknesses and identify hidden vulnerabilities."},
  {term:"Zed Attack Proxy (ZAP)",definition:"Pen testing tool that identifies runtime vulnerabilities.",usage:"Simulate real-world attacks and uncover issues that static tools miss."}
];

const ROLES = {
  "Software Security Architect": [
    "Provide architectural and technical guidance to product security developers",
    "Design, plan, and implement secure coding practices and security testing",
    "Ensure that security practices meet software certification processes",
    "Drive security testing of products and test security-related tools",
    "Manage third-party vendors to meet security requirements",
    "Develop and execute security plans with reproducible development and high quality",
    "Engage in hands-on review and design of software including technical analysis of source code",
    "Guide the company through SDL for its SDLC, participating in threat modeling, pen testing, code review"
  ],
  "Software Security Champion": [
    "Enforce SDL by assisting the SSG that CIA and privacy are being followed",
    "Review and assist in conducting architecture security analysis and threat modeling",
    "Act as tools expert for development team on software security tools",
    "Be the eyes, ears, and advocate of centralized security team within development team",
    "Collocate with development team to drive daily security awareness",
    "Attend security meetings and participate as members of software security champion group"
  ],
  "Software Security Evangelist": [
    "Evangelize the overall SDL process across the organization",
    "Provide training for Software Security Champions",
    "Promote and promulgate security policy across the company",
    "Enforce policy compliance for the entire organization",
    "Operate locally with software product management",
    "Drive the assessment and remediation of claimed vulnerabilities"
  ],
  "Product Security Incident Response Team (PSIRT)": [
    "Receive and validate external vulnerability reports",
    "Assess vulnerability severity and impact on products",
    "Coordinate remediation and patch development across teams",
    "Manage disclosure timelines and communication with researchers",
    "Prepare security advisories and post-release vulnerability information"
  ],
  "Security Development Team": [
    "Conduct security assessments during A1 phase",
    "Perform threat modeling and architecture review during A2",
    "Review code security and implement controls during A3",
    "Execute security testing and validate controls during A4",
    "Perform final security review and pen testing during A5"
  ]
};

const SDL_FOCUS = {
  "Security Assessment (A1) phase": "Product risks are evaluated; SDL project plan created with threat profile, risk profile, and compliance coverage",
  "Architecture (A2) phase": "Threat modeling performed; DFDs created; decomposition, trust boundaries, data flows analyzed; risk mitigation strategy established",
  "Design and Development (A3) phase": "Security requirements implemented; secure coding practiced; design security analysis performed; privacy implementation assessed",
  "Design and Development (A4) phase": "Security testing executed; code review performed; security analysis tools run; policy compliance verified",
  "Ship (A5) phase": "Final vulnerability scanning performed; penetration testing completed; open-source licensing reviewed; final security and privacy approvals obtained",
  "Post-Release Support phase": "External vulnerability disclosure handled; patches managed; incident response executed; legacy code assessed; security updates released"
};

/* =========================================================
   CERTIFICATION-STYLE QUESTION GENERATOR
   - No ‚Äúall of the above‚Äù
   - 4 options A‚ÄìD
   - No duplicate option text (enforced)
   - Practice explanations: detailed (>=3 sentences)
   - Correct explanations: detailed + why other options are wrong
   ========================================================= */
function categorizeTerm(t){
  const s = (t.term||"").toLowerCase();
  if(/stride|dread|threat model|threat|data flow|dfd|trust boundary|asset|attack tree|attack surface|spoofing|tampering|repudiation|information disclosure|denial of service|elevation of privilege/.test(s)) return "Threat Modeling";
  if(/scanner|scan|zap|nmap|spider|proxy|passive|active|intrusive/.test(s)) return "Scanning & Tools";
  if(/static analysis|dynamic analysis|fuzz|white.?box|black.?box|gray.?box|penetration|code review|system test|functional test|verification|testing|test|script/.test(s)) return "Testing & Verification";
  if(/cve|cvss|nvd|policy|compliance|benchmark|metric|measurement|risk profile|traceability|metric model|governance/.test(s)) return "Governance & Measurement";
  // Only recognize actual SDL phases (A1-A5) and SDLC, not generic "phase" terms
  if(/\b(a1|a2|a3|a4|a5)\b|security assessment.*phase|architecture.*phase|design and development.*phase|ship.*phase|post.?release|sdlc?|planning phase|requirement phase|design phase|implementation phase|deployment phase|maintenance phase/.test(s)) return "Lifecycle & Process";
  if(/agile|scrum|waterfall|v.?model|extreme programming|methodology/.test(s)) return "Methodologies";
  if(/champion|psirt|evangelist|architect|role|team|incident response|response/.test(s)) return "Roles & Response";
  return "Core Concepts";
}

function buildClue(term){
  const raw = (term.usage || term.definition || "").trim();
  if(!raw) return "";
  const first = raw.split(".")[0].trim();
  return first || raw;
}

function normalizeSentence(text){
  const t = (text || "").trim();
  if(!t) return "";
  return t.replace(/[.\s]+$/g, "");
}

function getTermByName(name){
  return TERMS.find(x => (x.term || "").toLowerCase() === (name || "").toLowerCase()) || null;
}

function formatTermExplain(termObj){
  if(!termObj) return "";
  const def = (termObj.definition || "").trim();
  const use = (termObj.usage || "").trim();
  if(def && use) return `${normalizeSentence(def)}. ${normalizeSentence(use)}.`;
  if(def) return `${normalizeSentence(def)}.`;
  if(use) return `${normalizeSentence(use)}.`;
  return "";
}

// pick plausible distractors: same category first
function pickDistractors(correctTerm, rng){
  const cat = categorizeTerm(correctTerm);
  const same = TERMS.filter(x => x.term !== correctTerm.term && categorizeTerm(x) === cat);
  const other = TERMS.filter(x => x.term !== correctTerm.term && categorizeTerm(x) !== cat);

  const a = shuffle(same, rng).slice(0, 6);
  const b = shuffle(other, rng).slice(0, 12);

  // pick 3 total, prefer 2 same-cat + 1 other
  let pool = [];
  if(a.length >= 2){
    pool = [a[0], a[1], b[0] || a[2] || other[0]];
  } else {
    pool = [b[0], b[1], b[2]];
  }
  // ensure unique
  const seen = new Set([correctTerm.term.toLowerCase()]);
  const out = [];
  for(const x of pool){
    if(!x) continue;
    const k = x.term.toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(x);
    if(out.length === 3) break;
  }
  // if still short, fill
  for(const x of shuffle(other, rng)){
    if(out.length===3) break;
    const k = x.term.toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(x);
  }
  return out.slice(0,3);
}

function detailedScenarioStem(term, rng) {
  const cat = categorizeTerm(term);
  const pick = (arr) => arr[Math.floor(rng() * arr.length)];
  
  const usage = (term.usage || term.definition || "").toLowerCase();
  const termName = term.term.toLowerCase();
  
  // Specific scenarios for Testing & Verification terms
  if (termName === "fuzz testing") {
    const fuzzScenarios = [
      `Your team is developing a payment processing API that handles credit card transactions. During sprint review, QA discovered that sending malformed JSON payloads with extremely long strings, special characters, and null bytes causes the parser to throw unhandled exceptions. The release is scheduled in 5 days. You need an automated approach that can generate thousands of invalid inputs to test all parser code paths and identify similar vulnerabilities. The solution must integrate with CI/CD and provide reproducible test cases. Which testing technique should you implement?`,
      
      `Your team built a file upload feature that processes PDFs, images, and Office documents. Security testing must verify the system handles corrupted files, oversized uploads, files with malicious payloads, and unusual MIME types safely. You need evidence that error handling prevents crashes and that the system fails securely. The testing should reveal weaknesses in input validation and parser robustness with minimal manual effort. What testing strategy fits these requirements?`
    ];
    return pick(fuzzScenarios);
  }
  
  if (termName === "static analysis") {
    return `Your organization maintains a legacy C++ application with known buffer overflow vulnerabilities. The codebase is 500,000 lines, and manual code review would take months. You need to identify security issues like SQL injection, XSS, insecure API usage, and buffer overflows before the security audit next month. The solution must analyze the code without executing it and provide line-number references to vulnerabilities. Management wants automated scanning that developers can run during development. What technique should you prioritize?`;
  }
  
  if (termName === "dynamic analysis") {
    const dynamicScenarios = [
      `You are reviewing a web application before production deployment. The security team needs to validate all authentication flows, session management, and authorization checks without access to source code. The application is deployed in a staging environment that mirrors production. You have API documentation and user credentials for different role levels. Time is limited, and you need to verify that the application handles edge cases and security controls correctly during actual execution. What testing approach is most appropriate?`,
      
      `A microservices architecture uses authentication tokens and encrypts data at rest. Before launch, the security team must verify that JWT validation, encryption implementations, and API authorization rules work correctly under real-world conditions. You need to test with actual HTTP traffic, database queries, and third-party service calls to ensure runtime security controls function as designed. The application must remain running during testing. Which approach validates runtime security effectively?`
    ];
    return pick(dynamicScenarios);
  }
  
  if (cat === "Threat Modeling") {
    const scenarios = [
      `Your team is designing a new healthcare portal that will store patient records, integrate with insurance systems, and allow patients to schedule appointments. The system has external APIs for partners, internal admin interfaces, and mobile apps. Before writing any code, the security architect wants to identify where trust boundaries exist, what data flows between components, which assets attackers might target, and what security controls are needed. The goal is to find and mitigate threats during design rather than after deployment. What security activity should the team perform first?`,
      
      `A financial services company is building a trading platform that processes real-time stock transactions. Senior management is concerned about potential attacks: unauthorized trading, data breaches, denial of service, and insider threats. The architecture includes web servers, APIs, databases, message queues, and third-party market data feeds. The security team needs a structured way to categorize threats, evaluate their severity, and prioritize which risks to address with limited budget and time. What framework should they use to systematically analyze threats?`,
      
      `You are reviewing the architecture for a multi-tenant SaaS application. The system has user authentication, role-based access control, data encryption, audit logging, and API rate limiting. Each component must be analyzed for specific threat categories: identity spoofing, data tampering, repudiation of actions, information disclosure, denial of service, and privilege escalation. The team needs a methodology that maps threats to each architectural element and ensures comprehensive coverage. Which threat analysis approach provides this systematic categorization?`,
      
      `Your organization is developing a cloud-native application with containers, serverless functions, and managed databases. The CTO wants to know: What are the most critical assets? What threats could compromise them? What is the likelihood and impact of each threat? Security must be prioritized based on business risk, not just technical vulnerability. The assessment should guide budget allocation for security controls. What type of security analysis delivers business-focused risk evaluation?`,
      
      `An IoT platform connects millions of devices, processes telemetry data, and sends commands to devices in the field. The architecture review identified trust boundaries between device firmware, cloud APIs, data storage, and admin consoles. Security needs to understand how data flows through the system, where it's validated, where it's stored, and what security controls protect each transition. The team needs a visual way to analyze the system architecture and identify where attacks might occur. What modeling technique best supports this architectural analysis?`
    ];
    return pick(scenarios);
  }
  
  // Specific scenarios for SDL Phase terms
  if (termName === "security assessment (a1) phase") {
    return `Your project team has just completed initial requirements gathering for a new customer data platform. The product will handle PII including names, addresses, payment information, and health data. Before any design or coding begins, the security team must evaluate business risks, establish security goals, define compliance requirements (GDPR, HIPAA, PCI-DSS), and create a security plan. This assessment will determine how rigorous security testing must be and what security activities are needed throughout development. Which SDL phase is the team entering?`;
  }
  
  if (termName === "ship (a5) phase") {
    return `Development has finished writing code for a new features release. The application is now in staging, and the security team is conducting final validation before production deployment. Activities include: penetration testing of the deployed application, final vulnerability scans, security regression testing, open-source license compliance review, and obtaining security sign-off from stakeholders. The goal is to verify the application meets all security and compliance requirements before it goes live. What phase of the SDL is this?`;
  }
  
  if (termName === "design and development (a3) phase") {
    return `Your team is in active development of a REST API. Developers are writing code, committing to version control, and running unit tests. Security requirements specify that: all code must follow secure coding standards, static analysis must run on every commit, code reviews must check for security flaws, and secure libraries must be used for cryptography and input validation. The team needs continuous feedback on security issues while coding. Which SDL phase activities are being performed?`;
  }
  
  if (termName === "post-release support phase") {
    return `A production application has been running for two years. Yesterday, a security researcher disclosed a critical vulnerability via responsible disclosure. The PSIRT team validated the vulnerability, assessed its severity (CVSS 9.1), and determined it affects all customers. Now the team must: develop and test a security patch, prepare a security advisory, coordinate disclosure timing with the researcher, deploy the patch to production, and notify affected customers. What phase of the software lifecycle handles this scenario?`;
  }
  
  if (termName === "architecture (a2) phase") {
    return `The product architecture has been approved, and technical design is underway. The team is creating detailed component designs, defining APIs, selecting frameworks and libraries, and documenting data flows. Security activities include: performing threat modeling on the architecture, reviewing design documents for security weaknesses, validating that security controls from requirements are reflected in the design, and ensuring privacy requirements are addressed. Which SDL phase encompasses these activities?`;
  }
  
  if (cat === "Roles & Response") {
    const scenarios = [
      `Your organization needs someone to: provide technical security guidance to development teams, design secure architecture patterns, lead threat modeling sessions, review code for security vulnerabilities, drive security tool adoption, and participate in security incident response. This person must have deep technical expertise in software security and work hands-on with code and architecture. They will set the technical direction for secure development practices across the engineering organization. Which role matches these responsibilities?`,
      
      `A software development team of 15 engineers needs a dedicated person to: advocate for security within the team, attend security training and share knowledge, run security tools and interpret results, coordinate with the central security team, conduct peer code reviews for security issues, and ensure the team follows secure coding standards. This person remains a full-time developer but has additional security responsibilities and acts as the security liaison. What role best describes this position?`,
      
      `Your company is implementing SDL across 20 development teams. Someone must: promote SDL adoption organization-wide, train Security Champions across all teams, develop and communicate security policies, ensure policy compliance, drive security assessments for new projects, and evangelize security culture. This person operates at the organizational level, not embedded in individual teams, and focuses on process, policy, and education. Which role fits this scope?`,
      
      `A security researcher just emailed your company reporting a SQL injection vulnerability in your customer portal. Someone must: receive and validate the vulnerability report, assess severity and impact, coordinate with engineering to develop a fix, manage disclosure timeline with the researcher, prepare a security advisory, notify affected customers, and track the issue through resolution. This requires managing external vulnerability disclosures and coordinating cross-functional response. What team handles this responsibility?`,
      
      `Your organization needs to establish a person who will: drive threat modeling during architecture reviews, ensure security activities happen in each SDL phase (A1 through A5), conduct security assessments of new projects, coordinate penetration testing, review security test results, and validate that security requirements are met before release. This person owns security quality gates across the development lifecycle. Which role owns end-to-end SDL execution?`
    ];
    return pick(scenarios);
  }
  
  // Specific scenario for Metric Model term
  if (termName === "metric model") {
    return `Your organization scans applications weekly and generates hundreds of findings. The compliance team asks: "How do we prove we're fixing the most critical issues first? How do we measure if our security posture is improving over time? How do we track remediation progress across 50 applications?" Management wants metrics that demonstrate security effectiveness and support audit requirements. The solution must provide consistent measurement across tools and teams. What framework enables security measurement and tracking at scale?`;
  }
  
  // Generic scenarios for other Governance & Measurement terms
  if (cat === "Governance & Measurement") {
    const scenarios = [
      `Your security team uses multiple scanning tools: one reports "HIGH severity SQL injection," another reports "CRITICAL severity injection vulnerability" for the same issue. Different vendors use incompatible severity scales, making it impossible to prioritize findings consistently across tools. The team needs a standardized way to score vulnerability severity so that findings can be compared, prioritized, and tracked uniformly regardless of which tool discovered them. What system provides this standardized scoring?`,
      
      `A new vulnerability is discovered in OpenSSL, and your security team needs to quickly identify which applications are affected. You need a way to reference this specific vulnerability consistently across all security tools, databases, and communications so teams can search their environments and validate if they're vulnerable. The identifier must be universally recognized and work across different vendors' tools. What naming system provides this common vulnerability reference?`,
      
      `Your company is merging with another organization. Due diligence requires evaluating the acquisition target's security program. You need to assess: Do they have secure coding practices? Do they perform threat modeling? Do they do security testing? How mature is their SDL? The evaluation must be objective, measurable, and comparable to your organization's practices. What framework provides a maturity model for assessing software security programs?`
    ];
    return pick(scenarios);
  }
  
  // Specific scenario for Spider term
  if (termName === "spider") {
    return `You're assessing a large web application with hundreds of pages and dynamic content. Before running vulnerability tests, you need to map the entire application: discover all URLs, forms, API endpoints, parameters, and inputs. The tool must crawl the application like a search engine, following links, submitting forms, and executing JavaScript to build a complete map of the attack surface. What tool creates this comprehensive application map?`;
  }
  
  if (cat === "Scanning & Tools") {
    const scenarios = [
      `Your security team needs to scan production web applications without disrupting business operations. The scanning must identify vulnerabilities like missing security headers, insecure cookies, potential XSS, and information disclosure, but cannot send attack payloads or modify data. The tool should analyze HTTP traffic passively as the application runs under normal use. This scan must be safe to run continuously in production environments. What scanning approach meets these requirements?`,
      
      `Before a major release, security must validate the entire application for vulnerabilities. The scan should test for SQL injection, XSS, CSRF, authentication bypass, and other OWASP Top 10 issues by actually sending exploit attempts and analyzing responses. The application is deployed in staging, and aggressive testing is acceptable. You need comprehensive coverage of all vulnerabilities that can be detected through black-box testing. What scanner type should you use?`,
      
      `Your team is scanning an internal application that requires login. Unauthenticated scans only see the login page and miss 90% of the application's functionality. The security team has test credentials and wants the scanner to log in, navigate through the application using valid sessions, and test authenticated features, API endpoints, and admin functions. This will significantly improve coverage and reduce false negatives. What scanning approach requires credentials to test internal application features?`,
      
      `Your security team needs a tool that integrates multiple capabilities: it should automatically discover the application structure, provide both passive analysis and active testing, allow manual testing workflows, and generate detailed reports. The tool must help security testers perform comprehensive web application assessments combining automated scanning with manual verification. What type of tool provides this integrated testing platform?`
    ];
    return pick(scenarios);
  }
  
  if (cat === "Methodologies") {
    const scenarios = [
      `Your project has well-defined requirements that are unlikely to change. The system must meet strict regulatory compliance with documented security gates at each phase. The customer expects a fixed-price contract with clear deliverables. Security reviews must be formal and documented before proceeding to the next phase. The project needs predictable timelines and comprehensive documentation. Which development methodology fits these requirements?`,
      
      `Your startup is building a new product with evolving requirements. Customer feedback will drive feature priorities, and the team needs to release working software every 2-3 weeks. Security must be integrated without slowing down rapid iterations. The development approach emphasizes collaboration, quick adaptation to change, and continuous delivery of value. Which methodology supports this fast-paced, feedback-driven development?`,
      
      `Your team is developing safety-critical software where security requirements must be verified at each stage. For every development phase (requirements, design, implementation), there must be a corresponding testing phase that validates security controls were implemented correctly. The methodology ensures traceability between requirements and tests, with security verification mirroring each development step. What development model enforces this parallel testing structure?`,
      
      `Your development team wants to improve code quality and security through: pair programming, continuous integration with automated tests, test-driven development, frequent small releases, and collective code ownership. The approach emphasizes engineering excellence, automated testing, and rapid feedback loops. Developers write tests before code, refactor continuously, and maintain a sustainable pace. Which agile methodology focuses on these technical practices?`,
      
      `Your organization needs a framework to assess and improve its software security practices over time. The framework should evaluate current security activities (like threat modeling, security testing, and security training), measure maturity levels, and provide a roadmap for improvement. This assessment model is based on observing real-world security programs, not prescriptive requirements. What framework offers this maturity-based assessment approach?`
    ];
    return pick(scenarios);
  }
  
  // Specific scenario for Vulnerability term
  if (termName === "vulnerability") {
    return `During a security review, the team identified several weaknesses in the application: insecure configurations, missing security controls, design flaws that could be exploited, and outdated components with known security issues. Management wants to understand what category these security findings fall into and how to prioritize remediation efforts. What term best describes these types of security weaknesses that attackers could potentially exploit?`;
  }
  
  // Specific scenario for Requirement Traceability Matrix term
  if (termName === "requirement traceability matrix") {
    return `Development teams must follow security policies, but compliance is inconsistent. The security team wants to track: Are security requirements documented? Is threat modeling performed? Are code reviews completed? Are security tests passed? They need a traceability system that maps every security requirement to design decisions, code implementations, and test results, ensuring nothing is missed and providing audit evidence. What artifact provides this requirement-to-implementation mapping?`;
  }
  
  // Default scenarios for other Core Concepts terms
  const defaultScenarios = [
    `Your team is developing a cloud-based platform that handles sensitive customer data. Leadership wants to ensure security is built into the development process from the beginning. The security team needs to establish when security activities should occur, what security controls are required, and how to validate that security requirements are met. They need a systematic approach that works throughout the development lifecycle. The goal is to reduce vulnerabilities and ensure compliance with security standards. What framework or approach should guide the team's security efforts?`,
    
    `A security audit identified gaps in your organization's software development practices. Management wants to improve security across all development teams. The team needs guidance on: when to perform threat modeling, how to validate security requirements, what testing to perform, and how to handle vulnerabilities after release. The approach must integrate security into existing development workflows without requiring a complete process overhaul. What methodology or framework should the organization adopt?`
  ];
  
  return pick(defaultScenarios);
}

function buildRationaleCorrect(term, optionTexts, correctIdx, scenarioNeed){
  const correctName = term.term;
  const correctExplain = formatTermExplain(term);

  const others = optionTexts
    .map((txt, i)=>({txt, i}))
    .filter(x=>x.i !== correctIdx)
    .map(x => {
      const t = getTermByName(x.txt);
      const line = t ? formatTermExplain(t) : "";
      return `‚Ä¢ <strong>${x.txt}</strong>: ${line}`;
    })
    .join("<br><br>");

  return `
    <strong>Correct</strong><br><br>
    <strong>${correctName}</strong> is correct because ${correctExplain}
    ${scenarioNeed ? ` This matches the scenario need: <em>${scenarioNeed}</em>.` : ``}
    <br><br>
    <strong>Why the other options are not the best fit:</strong><br><br>
    ${others}
  `;
}

function buildRationaleWrong(selectedTerm, scenarioNeed){
  const name = selectedTerm?.term || "This option";
  const explain = formatTermExplain(selectedTerm);

  return `
    <strong>${name}</strong> is not the best fit here.<br><br>
    ${explain}
    ${scenarioNeed ? `<br><br><strong>What the scenario is really asking for:</strong> ${scenarioNeed}.` : ``}
  `;
}

function buildTermQuestion(correctTerm, rng){
  try {
    const stem = detailedScenarioStem(correctTerm, rng);
    const distractors = pickDistractors(correctTerm, rng);

  // options are term NAMES (cert-style: still applied because stem is scenario)
  const optionTerms = [correctTerm, ...distractors];

  // Enforce unique option text (this fixes the ‚Äúsame selection twice‚Äù issue)
  const optionText = unique(optionTerms.map(t => t.term)).slice(0,4);

  // If uniqueness reduced count (rare), fill from random unique terms
  if(optionText.length < 4){
    for(const t of shuffle(TERMS, rng)){
      if(optionText.length === 4) break;
      if(optionText.some(x => x.toLowerCase() === t.term.toLowerCase())) continue;
      optionText.push(t.term);
    }
  }

  // Determine which option is correct (by term text)
  let correctIdx = optionText.findIndex(x => x.toLowerCase() === correctTerm.term.toLowerCase());
  if(correctIdx < 0){
    // force include correct, replace last
    optionText[3] = correctTerm.term;
    correctIdx = 3;
  }

  const optionObjs = optionText.map((t,i)=>({
    key: String.fromCharCode(65+i),
    text: t
  }));

  const correctKey = optionObjs[correctIdx].key;

  const scenarioNeed = categorizeTerm(correctTerm) + " objective";

  // Build per-option rationales (for practice wrong selection)
  const optionToTermObj = {};
  for(const t of optionText){
    const found = TERMS.find(x => x.term.toLowerCase() === t.toLowerCase());
    optionToTermObj[t] = found || {term:t, definition:"", usage:""};
  }

  const rationales = {};
  for(const opt of optionObjs){
    const termObj = optionToTermObj[opt.text];
    rationales[opt.key] = {
      // if chosen and wrong, we show this (no correct reveal)
      wrong: buildRationaleWrong(termObj, scenarioNeed),
      // if correct chosen, we show full explanation (includes why others wrong)
      correctFull: null
    };
  }
  // correct explanation once (full, includes other options)
  const explainCorrectFull = buildRationaleCorrect(correctTerm, optionText, correctIdx, scenarioNeed);
  rationales[correctKey].correctFull = explainCorrectFull;

  return {
    id: null, // assigned later
    type: "Certification Scenario (Concept Match)",
    category: categorizeTerm(correctTerm),
    stem,
    options: optionObjs,
    correctKey,
    rationales
  };
  } catch(e) {
    console.error("Error building question for term:", correctTerm.term, e.message);
    throw e;
  }
}

function buildRoleQuestion(rng){
  const roleNames = Object.keys(ROLES);
  const role = roleNames[Math.floor(rng()*roleNames.length)];
  const responsibilities = ROLES[role] || [];
  const resp = responsibilities[Math.floor(rng()*responsibilities.length)] || "Support SDL security activities";

  const stem = `A program needs a person who can do the following consistently and at scale:\n\n"${resp}"\n\nWhich role best matches?`;

  const distractors = shuffle(roleNames.filter(r=>r!==role), rng).slice(0,3);
  const optionText = shuffle([role, ...distractors], rng);

  const options = optionText.map((t,i)=>({ key:String.fromCharCode(65+i), text:t }));
  const correctKey = options.find(o=>o.text===role).key;

  const rationales = {};
  const scenarioNeed = "ownership and scope (architectural leadership vs team-level championing vs org-wide evangelism)";
  const roleExplain = (name) => {
    const list = ROLES[name] || [];
    if(!list.length) return "This role supports security activities across the organization.";
    const a = normalizeSentence(list[0]);
    const b = normalizeSentence(list[1] || list[0]);
    return `${a}. ${b}.`;
  };

  for(const o of options){
    rationales[o.key] = {
      wrong: `
        <strong>Not correct ‚Äî teaching explanation</strong><br><br>
        <strong>What this role means:</strong> ${roleExplain(o.text)}<br><br>
        <strong>Why this is not the best fit:</strong> The prompt emphasizes ${scenarioNeed}. This role can contribute, but it does not own the end-to-end responsibility described. Match the role that is accountable for driving the work, not just supporting it.
      `,
      correctFull: null
    };
  }

  const otherLines = options
    .filter(o=>o.key!==correctKey)
    .map(o=>{
      const base = roleExplain(o.text);
      return `‚Ä¢ <strong>${o.text}</strong>: ${base} It typically supports the work rather than owning it. The scope and authority do not align as closely with the responsibility described.`;
    })
    .join("<br><br>");

  rationales[correctKey].correctFull = `
    <strong>Correct ‚Äî teaching explanation</strong><br><br>
    <strong>What this role means:</strong> ${roleExplain(role)}<br><br>
    <strong>Why this is the correct answer:</strong> The <strong>${role}</strong> is expected to handle responsibilities like ‚Äú${resp}‚Äù as part of its core job scope. It owns the work, has the authority to execute it, and matches the accountability level required. This aligns directly with ${scenarioNeed}.<br><br>
    <strong>Why the other options are not the best fit:</strong><br><br>
    ${otherLines}
  `;

  return {
    id: null,
    type: "Certification Scenario (Role Alignment)",
    category: "Roles & Responsibilities",
    stem,
    options,
    correctKey,
    rationales
  };
}

function questionSignature(q){
  const opt = (q.options||[]).map(o=>o.text).join("|");
  return `${q.type}::${q.category}::${q.stem}::${opt}`;
}

function assignUniqueId(q, attemptSeed, idx){
  const sig = questionSignature(q);
  const h = simpleHash(sig);
  q.id = `q_${attemptSeed}_${idx}_${h}`;
  return q;
}

function generateAttemptQuestions(seed){
  console.log("Starting question generation with TERMS length:", TERMS.length, "ROLES keys:", Object.keys(ROLES));
  
  const rng = mulberry32(seed);

  // Mix: mostly concept scenarios + some role scenarios
  const termCount = 88;
  const roleCount = 12;

  // choose unique terms without replacement
  const chosenTerms = shuffle(TERMS, rng).slice(0, Math.min(termCount, TERMS.length));
  const questions = [];

  // build term questions
  for(const t of chosenTerms){
    const q = buildTermQuestion(t, rng);
    questions.push(q);
  }

  // build role questions
  for(let i=0;i<roleCount;i++){
    questions.push(buildRoleQuestion(rng));
  }

  // ensure >= 100, fill with additional term questions using next terms (still unique per attempt)
  let cursor = termCount;
  while(questions.length < QUESTION_COUNT){
    const t = TERMS[(cursor++) % TERMS.length];
    const q = buildTermQuestion(t, rng);
    // avoid duplicates in same attempt
    const sig = questionSignature(q);
    if(questions.some(x=>questionSignature(x)===sig)) continue;
    questions.push(q);
    if(cursor > TERMS.length * 3) break; // safety
  }

  // shuffle + take exactly 100
  const final = shuffle(questions, rng).slice(0, QUESTION_COUNT);

  // assign unique IDs
  for(let i=0;i<final.length;i++){
    assignUniqueId(final[i], seed, i);
  }

  // answer order randomization per question (and keep correctKey + rationales aligned)
  for(let i=0;i<final.length;i++){
    const q = final[i];
    const prng = mulberry32(seed ^ (i*2654435761) ^ (q.id.length*97));

    const oldOpts = q.options.slice();
    const shuffled = shuffle(oldOpts, prng).map((o,idx)=>({ ...o, _oldKey:o.key, key:String.fromCharCode(65+idx) }));

    const map = {};
    for(const o of shuffled) map[o._oldKey] = o.key;

    // remap correctKey
    q.correctKey = map[q.correctKey];

    // remap rationales
    const newRat = {};
    for(const [oldK, val] of Object.entries(q.rationales || {})){
      const nk = map[oldK];
      if(nk) newRat[nk] = val;
    }
    q.rationales = newRat;

    // store options
    q.options = shuffled.map(o=>({ key:o.key, text:o.text }));
  }

  return final;
}

/* =========================================================
   APP STATE
   ========================================================= */
const state = {
  attempt: null,
  timerInterval: null,
  autoSaveInterval: null,
  lastActivityAt: Date.now()
};

/* =========================================================
   ATTEMPT MODEL
   ========================================================= */
function newAttempt({mode, timed, durationMinutes}){
  const seed = (Date.now() ^ Math.floor(Math.random()*1e9)) >>> 0;
  const questions = generateAttemptQuestions(seed);

  const totalMs = timed ? clamp(durationMinutes, 1, 240) * 60 * 1000 : null;

  return {
    id: `attempt_${seed}_${Date.now()}`,
    createdAt: nowISO(),
    mode,
    seed,
    timed,
    durationMs: totalMs,
    remainingMs: totalMs,
    timerRunning: timed ? true : false,
    pausedByIdle: false,
    currentIndex: 0,
    questions,
    answersByQid: {},     // { selectedKey, isCorrect, locked, tries, wrongSelectedKeys:[] }
    startedAtMs: Date.now(),
    finishedAtMs: null,
    submitted: false,
    feedbackByQid: {}     // persist feedback per question
  };
}

function loadActiveAttempt(){
  const raw = localStorage.getItem(LS.ACTIVE);
  return raw ? safeParse(raw, null) : null;
}
function saveActiveAttempt(){
  if(!state.attempt) return;
  localStorage.setItem(LS.ACTIVE, JSON.stringify(state.attempt));
}
function clearActiveAttempt(){
  localStorage.removeItem(LS.ACTIVE);
  state.attempt = null;
}

/* =========================================================
   ATTEMPT HISTORY
   ========================================================= */
function loadAttemptHistory(){
  return safeParse(localStorage.getItem(LS.ATTEMPTS), []);
}
function saveAttemptHistory(list){
  localStorage.setItem(LS.ATTEMPTS, JSON.stringify(list));
}
function addAttemptToHistory(summary){
  const hist = loadAttemptHistory();
  hist.unshift(summary);
  saveAttemptHistory(hist.slice(0,50));
}

/* =========================================================
   TIMER + IDLE
   ========================================================= */
function showToast(msg){ console.log(msg); }

function markActivity(){
  state.lastActivityAt = Date.now();
}
["click","keydown","mousemove","touchstart","scroll"].forEach(ev=>{
  window.addEventListener(ev, ()=>markActivity(), {passive:true});
});

function startTimerLoop(){
  stopTimerLoop();
  if(!state.attempt?.timed) return;

  state.timerInterval = setInterval(()=>{
    const a = state.attempt;
    if(!a || !a.timed) return;

    // idle pause after 10 minutes inactivity
    const idleFor = Date.now() - state.lastActivityAt;
    if(a.timerRunning && idleFor >= IDLE_TIMEOUT_MS){
      a.timerRunning = false;
      a.pausedByIdle = true;
      saveActiveAttempt();
      updateUI();
      showToast('Paused due to inactivity (progress saved). Click "Resume timer" to continue.');
      return;
    }

    if(!a.timerRunning) return;

    a.remainingMs = Math.max(0, (a.remainingMs ?? 0) - 1000);

    if(a.remainingMs <= 0){
      a.timerRunning = false;
      a.remainingMs = 0;
      saveActiveAttempt();
      updateUI();
      showToast("Time is up. Submitting attempt.");
      submitAttempt();
      return;
    }

    saveActiveAttempt();
    updateUITimerOnly();
  }, 1000);
}

function stopTimerLoop(){
  if(state.timerInterval){
    clearInterval(state.timerInterval);
    state.timerInterval = null;
  }
}
function startAutosave(){
  stopAutosave();
  state.autoSaveInterval = setInterval(()=>saveActiveAttempt(), AUTO_SAVE_MS);
}
function stopAutosave(){
  if(state.autoSaveInterval){
    clearInterval(state.autoSaveInterval);
    state.autoSaveInterval = null;
  }
}

/* =========================================================
   MODAL
   ========================================================= */
function showModal(title, html){
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = html;
  $("modalBackdrop").classList.add("show");
}
function closeModal(){
  $("modalBackdrop").classList.remove("show");
}

/* =========================================================
   PRACTICE + EXAM SELECTION LOGIC (CORRECT LOCKING)
   - Practice:
     wrong => detailed why wrong (>=3 sentences), allow retry, do NOT reveal correct
     correct => detailed full explanation + why other options are wrong, lock ONLY this question
   - Exam:
     record answer (no lock, no teaching feedback)
   ========================================================= */
function selectChoice(selectedKey){
  const a = state.attempt;
  if(!a) return;

  const q = a.questions[a.currentIndex];
  if(!q) return;

  const isPractice = a.mode === "practice";

  const qState = (a.answersByQid[q.id] ||= {
    selectedKey: null,
    isCorrect: false,
    locked: false,
    tries: 0,
    wrongSelectedKeys: [],
    flagged: false
  });

  // only block if THIS question is locked
  if(qState.locked) return;

  qState.selectedKey = selectedKey;
  qState.tries = (qState.tries || 0) + 1;

  const isCorrect = selectedKey === q.correctKey;

  // feedback UI
  const fb = $("feedbackBox");
  const fbTitle = $("feedbackTitle");
  const fbText = $("feedbackText");
  const fbMini = $("feedbackMini");

  function showFeedback(kind, title, html, mini=""){
    fb.classList.remove("good","warn");
    fb.classList.add("show", kind);
    fbTitle.textContent = title;
    fbText.innerHTML = html;
    fbMini.textContent = mini;
  }

  if(isPractice){
    if(isCorrect){
      qState.isCorrect = true;
      qState.locked = true; // lock ONLY this question

      const full = q.rationales?.[selectedKey]?.correctFull || `
        <strong>Why this is correct:</strong> This choice best matches the scenario‚Äôs requirements and objective. It is the option that most directly solves the problem described without introducing unnecessary risk. In certification questions, the best answer is the one that fits the scenario‚Äôs timing, environment, and risk priority.
      `;

      showFeedback(
        "good",
        "Correct ‚Äî teaching explanation",
        full,
        "This question is now locked because you answered it correctly."
      );

      a.feedbackByQid[q.id] = { kind:"good", title:"Correct ‚Äî teaching explanation", html: full, mini:"This question is now locked because you answered it correctly." };
    } else {
      qState.isCorrect = false;
      if(!qState.wrongSelectedKeys.includes(selectedKey)){
        qState.wrongSelectedKeys.push(selectedKey);
      }

      const wrong = q.rationales?.[selectedKey]?.wrong || `
        <strong>Why your selection is not correct:</strong> Your choice is related, but it does not satisfy the scenario‚Äôs main constraint or objective. Re-read the stem and identify what must be optimized (risk reduction, timing, environment safety, or scope). Then choose the option that most directly supports that objective.
      `;

      // IMPORTANT: do NOT reveal correct
      const addTry = `<br><br><strong>Try again:</strong> Choose another option that better matches the scenario.`;
      showFeedback("warn", "Not quite ‚Äî why your selection is wrong", wrong + addTry, "No correct answer is revealed in practice mode unless you select it.");

      a.feedbackByQid[q.id] = { kind:"warn", title:"Not quite ‚Äî why your selection is wrong", html: wrong + addTry, mini:"No correct answer is revealed in practice mode unless you select it." };
    }

    saveActiveAttempt();
    updateUI();
    renderQuestion();
    return;
  }

  // Exam mode: no teaching feedback; allow changing selection
  qState.isCorrect = isCorrect;
  a.feedbackByQid[q.id] = null; // keep exam clean
  saveActiveAttempt();
  updateUI();
  renderQuestion();
}

/* =========================================================
   RENDER
   ========================================================= */
function renderQuestion(){
  const a = state.attempt;

  if(!a){
    $("qStem").textContent = 'Click ‚ÄúStart new attempt‚Äù.';
    $("choices").innerHTML = "";
    $("feedbackBox").classList.remove("show","good","warn");
    $("qStatusTag").textContent = "‚Äî";
    $("qNumberTag").textContent = "#‚Äî";
    $("qCategoryTag").textContent = "‚Äî";
    $("qTypeTag").textContent = "‚Äî";
    renderNavGrid();
    return;
  }

  const q = a.questions[a.currentIndex];
  if(!q) return;

  const qState = (a.answersByQid[q.id] ||= {
    selectedKey: null,
    isCorrect: false,
    locked: false,
    tries: 0,
    wrongSelectedKeys: [],
    flagged: false
  });

  $("qNumberTag").textContent = `#${a.currentIndex+1}`;
  $("qCategoryTag").textContent = q.category || "‚Äî";
  $("qTypeTag").textContent = q.type || "‚Äî";

  if(a.mode==="practice" && qState.locked) $("qStatusTag").textContent = "Locked ‚úÖ";
  else if(qState.selectedKey) $("qStatusTag").textContent = "Answered";
  else $("qStatusTag").textContent = "Unanswered";

  // Update flag button
  const flagBtn = $("btnFlag");
  if(qState.flagged){
    flagBtn.textContent = "üö© Flagged";
    flagBtn.style.background = "rgba(255,77,109,.18)";
    flagBtn.style.borderColor = "rgba(255,77,109,.45)";
  } else {
    flagBtn.textContent = "üö© Flag";
    flagBtn.style.background = "";
    flagBtn.style.borderColor = "";
  }

  $("qStem").textContent = q.stem;

  const choicesEl = $("choices");
  choicesEl.innerHTML = "";

  const disabled = !!qState.locked; // only disable if locked
  q.options.forEach((opt, idx)=>{
    const div = document.createElement("div");
    div.className = "choice";
    if(disabled) div.classList.add("disabled");

    // highlight current selection
    if(qState.selectedKey === opt.key){
      div.classList.add("selected");
    }

    // mark tried wrong options (practice only)
    const triedWrong = (a.mode==="practice") && (qState.wrongSelectedKeys||[]).includes(opt.key) && !qState.locked;
    if(triedWrong) div.classList.add("triedWrong");

    // highlight correct answer when locked (practice)
    if(a.mode === "practice" && qState.locked && opt.key === q.correctKey){
      div.classList.add("correct");
    }

    div.innerHTML = `
      <div class="bullet">${String.fromCharCode(65+idx)}</div>
      <div class="txt"><div class="main">${opt.text}</div></div>
    `;

    if(!disabled){
      div.addEventListener("click", ()=>selectChoice(opt.key));
    }
    choicesEl.appendChild(div);
  });

  // Feedback persistence
  const fb = $("feedbackBox");
  fb.classList.remove("show","good","warn");
  const saved = a.feedbackByQid?.[q.id];
  if(saved){
    fb.classList.add("show", saved.kind);
    $("feedbackTitle").textContent = saved.title;
    $("feedbackText").innerHTML = saved.html;
    $("feedbackMini").textContent = saved.mini || "";
  }

  renderNavGrid();
}

function renderNavGrid(){
  const nav = $("navGrid");
  nav.innerHTML = "";
  const a = state.attempt;
  if(!a) return;

  for(let i=0;i<a.questions.length;i++){
    const q = a.questions[i];
    const st = a.answersByQid?.[q.id] || {};

    const btn = document.createElement("button");
    btn.className = "navBtn";
    if(i===a.currentIndex) btn.classList.add("active");

    const isLocked = !!st.locked;
    const hasWrong = (st.wrongSelectedKeys && st.wrongSelectedKeys.length>0) && !isLocked;
    const hasAnswer = !!st.selectedKey;
    const isUnanswered = !hasAnswer && !hasWrong && !isLocked;
    const isFlagged = !!st.flagged;

    if(isLocked) btn.classList.add("locked");
    else if(hasWrong) btn.classList.add("tried");
    else if(hasAnswer) btn.classList.add("answered");
    else btn.classList.add("unanswered");
    
    if(isFlagged) btn.classList.add("flagged");

    btn.textContent = String(i+1);
    btn.title = (isFlagged ? "üö© " : "") + (isLocked ? "Locked (Correct)"
              : hasWrong ? "Tried (Not correct yet)"
              : hasAnswer ? "Answered"
              : "Unanswered");

    btn.addEventListener("click", ()=>{
      a.currentIndex = i;
      saveActiveAttempt();
      updateUI();
      renderQuestion();
    });

    nav.appendChild(btn);
  }
}

/* =========================================================
   REPORTING
   ========================================================= */
function buildAttemptReport(a){
  const totalsByCat = {};
  const correctByCat = {};
  const wrongByCat = {};

  let correct = 0, answered = 0;

  for(const q of a.questions){
    const cat = q.category || "Uncategorized";
    totalsByCat[cat] = (totalsByCat[cat]||0) + 1;

    const st = a.answersByQid?.[q.id];
    if(st?.selectedKey){
      answered++;
      if(st.isCorrect){
        correct++;
        correctByCat[cat] = (correctByCat[cat]||0) + 1;
      } else {
        wrongByCat[cat] = (wrongByCat[cat]||0) + 1;
      }
    }
  }

  const scorePct = answered ? Math.round((correct/answered)*100) : 0;

  const rows = Object.keys(totalsByCat).sort().map(cat=>{
    const c = correctByCat[cat]||0;
    const w = wrongByCat[cat]||0;
    const pct = (c+w) ? Math.round((c/(c+w))*100) : 0;
    return {cat, attempted:(c+w), c, w, pct};
  });

  const strengths = rows.filter(r=>r.attempted>=5).sort((a,b)=>b.pct-a.pct).slice(0,3);
  const weaknesses = rows.filter(r=>r.attempted>=5).sort((a,b)=>a.pct-b.pct).slice(0,3);

  function recommend(cat){
    if(cat==="Threat Modeling") return "Practice mapping STRIDE categories to DFD elements and trust boundaries. Then use DREAD-like thinking to prioritize what matters most based on impact and likelihood.";
    if(cat==="Testing & Verification") return "Reinforce when to use static vs dynamic analysis, black/white/gray box testing, fuzzing, and code review. Focus on matching the technique to the environment and the kind of evidence needed.";
    if(cat==="Scanning & Tools") return "Review passive vs active scanning tradeoffs, authenticated scanning value, and how spiders/proxies help discover true attack surface. Emphasize safe execution in staging vs production.";
    if(cat==="Governance & Measurement") return "Review CVE/CVSS/NVD relationships and how policies/traceability provide auditable proof. Practice deciding what belongs in compliance gates vs engineering controls.";
    if(cat==="Lifecycle & Process") return "Rehearse SDLC vs SDL relationships and what happens in each stage (assessment, architecture, development, verification, ship, post-release). Tie activities to the correct stage purpose.";
    if(cat==="Methodologies") return "Compare Agile vs Waterfall vs V-model and decide which fits given: stability of requirements, compliance needs, and feedback cycles.";
    if(cat==="Roles & Responsibilities") return "Differentiate architect vs champion vs evangelist responsibilities, and map incident response ownership (e.g., PSIRT) to post-release realities.";
    return "Revisit the definitions and, more importantly, practice reading scenario requirements and selecting the option that best fits the objective and timing.";
  }

  const timeTakenMs = a.finishedAtMs && a.startedAtMs ? (a.finishedAtMs - a.startedAtMs) : (Date.now() - a.startedAtMs);

  return {
    correct, answered, scorePct,
    timeTakenMs,
    rows,
    strengths,
    weaknesses,
    recommendations: weaknesses.map(w=>({cat:w.cat, text: recommend(w.cat)}))
  };
}

function renderReportHTML(report, attemptMeta){
  const timeMin = Math.floor(report.timeTakenMs/60000);
  const timeSec = Math.floor((report.timeTakenMs%60000)/1000);

  const strengthsHtml = report.strengths.length
    ? `<ul class="list">${report.strengths.map(s=>`<li><strong>${s.cat}</strong> ‚Äî ${s.pct}% accuracy on attempted items</li>`).join("")}</ul>`
    : `<div class="muted small">Not enough attempted items in a category to identify strengths yet.</div>`;

  const weakHtml = report.weaknesses.length
    ? `<ul class="list">${report.weaknesses.map(w=>`<li><strong>${w.cat}</strong> ‚Äî ${w.pct}% accuracy on attempted items</li>`).join("")}</ul>`
    : `<div class="muted small">Not enough attempted items in a category to identify weaknesses yet.</div>`;

  const recHtml = report.recommendations.length
    ? `<ul class="list">${report.recommendations.map(r=>`<li><strong>${r.cat}</strong>: ${r.text}</li>`).join("")}</ul>`
    : `<div class="muted small">No recommendations yet ‚Äî attempt more items to get targeted guidance.</div>`;

  const tableRows = report.rows.map(r=>{
    return `<tr>
      <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)"><strong>${r.cat}</strong></td>
      <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">${r.attempted}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">${r.c}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">${r.w}</td>
      <td style="padding:8px;border-bottom:1px solid rgba(255,255,255,.08)">${r.pct}%</td>
    </tr>`;
  }).join("");

  const modeLine = attemptMeta ? `${attemptMeta.mode.toUpperCase()} ‚Ä¢ ${attemptMeta.timed ? "Timed" : "Untimed"}` : "";

  return `
    <div class="attemptCard">
      <div class="top">
        <div class="title">Score</div>
        <div class="meta">${modeLine} ‚Ä¢ ${report.correct} correct / ${report.answered} answered (${report.scorePct}%) ‚Ä¢ Time: ${timeMin}m ${timeSec}s</div>
      </div>
    </div>

    <div class="twoCol">
      <div class="attemptCard">
        <div class="top"><div class="title">Strengths</div></div>
        ${strengthsHtml}
      </div>
      <div class="attemptCard">
        <div class="top"><div class="title">Weaknesses</div></div>
        ${weakHtml}
      </div>
    </div>

    <div class="attemptCard">
      <div class="top"><div class="title">What to study next</div></div>
      ${recHtml}
    </div>

    <div class="attemptCard">
      <div class="top"><div class="title">Category breakdown</div></div>
      <div style="overflow:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">Category</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">Attempted</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">Correct</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">Wrong</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,.12)">Accuracy</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
    </div>
  `;
}

/* =========================================================
   SUBMIT ATTEMPT
   ========================================================= */
function submitAttempt(){
  const a = state.attempt;
  if(!a || a.submitted) return;

  a.submitted = true;
  a.finishedAtMs = Date.now();
  a.timerRunning = false;

  const report = buildAttemptReport(a);

  addAttemptToHistory({
    id: a.id,
    createdAt: a.createdAt,
    mode: a.mode,
    timed: a.timed,
    durationMs: a.durationMs,
    timeTakenMs: report.timeTakenMs,
    answered: report.answered,
    correct: report.correct,
    scorePct: report.scorePct,
    report
  });

  // Clear active attempt so a brand-new attempt always starts clean
  clearActiveAttempt();
  stopTimerLoop();
  stopAutosave();
  updateUI();
  renderQuestion();

  showModal("Attempt Report", renderReportHTML(report, {mode:a.mode, timed:a.timed}));
}

/* =========================================================
   ATTEMPTS MODAL
   ========================================================= */
function openAttemptsModal(){
  const hist = loadAttemptHistory();
  if(!hist.length){
    showModal("Attempts", `<div class="muted small">No attempts saved yet.</div>`);
    return;
  }

  const cards = hist.map(h=>{
    const d = new Date(h.createdAt);
    const timeMin = Math.floor((h.timeTakenMs||0)/60000);
    const timeSec = Math.floor(((h.timeTakenMs||0)%60000)/1000);

    const weak = (h.report?.weaknesses||[]).map(w=>w.cat).join(", ");
    const recs = (h.report?.recommendations||[]).slice(0,2).map(r=>`<li><strong>${r.cat}</strong>: ${r.text}</li>`).join("");

    return `
      <div class="attemptCard">
        <div class="top">
          <div class="title">${h.mode.toUpperCase()} ‚Ä¢ ${h.scorePct}%</div>
          <div class="meta">${d.toLocaleString()} ‚Ä¢ ${h.correct}/${h.answered} ‚Ä¢ ${timeMin}m ${timeSec}s</div>
        </div>
        <div class="muted small"><strong>Weak areas:</strong> ${weak || "‚Äî"}</div>
        ${recs ? `<ul class="list">${recs}</ul>` : ``}
      </div>
    `;
  }).join("");

  showModal("Attempts (Saved Reports)", cards);
}

/* =========================================================
   UI UPDATE
   ========================================================= */
function updateUITimerOnly(){
  const a = state.attempt;
  if(!a){
    $("modePill").innerHTML = `Mode: <strong>‚Äî</strong>`;
    $("timerPill").innerHTML = `Time: <strong>‚Äî</strong>`;
    return;
  }

  $("modePill").innerHTML = `Mode: <strong>${a.mode === "practice" ? "Practice" : "Exam"}</strong>`;
  if(a.timed){
    const status = a.timerRunning ? "" : (a.pausedByIdle ? " (paused)" : " (paused)");
    $("timerPill").innerHTML = `Time: <strong>${fmtTime(a.remainingMs)}${status}</strong>`;
  } else {
    $("timerPill").innerHTML = `Time: <strong>Untimed</strong>`;
  }
}

function updateUI(){
  const a = state.attempt;

  const saved = !!loadActiveAttempt();
  $("resumeTag").style.display = saved ? "inline-flex" : "none";
  $("btnResume").style.display = saved ? "inline-block" : "none";

  updateUITimerOnly();

  if(!a){
    $("kpiProgress").textContent = `0 / ${QUESTION_COUNT}`;
    $("kpiLocked").textContent = "0";
    $("kpiAnswered").textContent = "0";
    $("kpiTried").textContent = "0";
    $("progressBar").style.width = "0%";
    $("progressText").textContent = `0% complete`;

    $("btnPrev").disabled = true;
    $("btnNext").disabled = true;
    $("btnSubmit").disabled = true;
    $("btnSave").disabled = true;
    $("btnPause").disabled = true;
    $("btnResumeTimer").style.display = "none";

    renderNavGrid();
    return;
  }

  $("btnPrev").disabled = false;
  $("btnNext").disabled = false;
  $("btnSubmit").disabled = false;
  $("btnSave").disabled = false;

  $("btnPause").disabled = !a.timed;
  $("btnResumeTimer").style.display = (a.timed && !a.timerRunning) ? "inline-block" : "none";

  let locked = 0, answered = 0, tried = 0, flagged = 0;
  for(const q of a.questions){
    const st = a.answersByQid?.[q.id];
    if(st?.locked) locked++;
    if(st?.selectedKey) answered++;
    if(st?.wrongSelectedKeys?.length && !st.locked) tried++;
    if(st?.flagged) flagged++;
  }

  $("kpiProgress").textContent = `${answered} / ${QUESTION_COUNT}`;
  $("kpiLocked").textContent = String(locked);
  $("kpiAnswered").textContent = String(answered);
  $("kpiTried").textContent = String(tried);
  $("kpiFlagged").textContent = String(flagged);

  const pct = Math.round((answered/QUESTION_COUNT)*100);
  $("progressBar").style.width = `${pct}%`;
  $("progressText").textContent = `${pct}% complete`;

  renderNavGrid();
}

/* =========================================================
   ACTIONS
   ========================================================= */
function startNewAttempt(){
  // Starting new attempt ALWAYS overwrites any active attempt (fixes ‚Äúnot letting me start new attempt‚Äù)
  localStorage.removeItem(LS.ACTIVE);

  const mode = $("modeSelect").value;

  // practice default untimed; exam default timed
  const isExam = (mode === "exam");
  const timedSwitchOn = $("timedSwitch").classList.contains("on");
  const timed = isExam ? true : timedSwitchOn;

  const durationMin = isExam ? 90 : clamp(parseInt($("durationInput").value || "90", 10), 1, 240);

  const attempt = newAttempt({
    mode,
    timed,
    durationMinutes: durationMin
  });

  state.attempt = attempt;
  state.lastActivityAt = Date.now();

  saveActiveAttempt();
  startAutosave();
  startTimerLoop();
  updateUI();
  renderQuestion();
}

function resumeAttempt(){
  const loaded = loadActiveAttempt();
  if(!loaded){
    showToast("No saved attempt found.");
    return;
  }
  state.attempt = loaded;
  state.lastActivityAt = Date.now();

  startAutosave();
  startTimerLoop();
  updateUI();
  renderQuestion();
}

function saveNow(){
  saveActiveAttempt();
  showToast("Saved.");
}

function goPrev(){
  const a = state.attempt;
  if(!a) return;
  a.currentIndex = Math.max(0, a.currentIndex-1);
  saveActiveAttempt();
  updateUI();
  renderQuestion();
}
function goNext(){
  const a = state.attempt;
  if(!a) return;
  a.currentIndex = Math.min(a.questions.length-1, a.currentIndex+1);
  saveActiveAttempt();
  updateUI();
  renderQuestion();
}

function toggleFlag(){
  const a = state.attempt;
  if(!a) return;
  const q = a.questions[a.currentIndex];
  if(!q) return;
  
  const qState = (a.answersByQid[q.id] ||= {
    selectedKey: null,
    isCorrect: false,
    locked: false,
    tries: 0,
    wrongSelectedKeys: [],
    flagged: false
  });
  
  qState.flagged = !qState.flagged;
  saveActiveAttempt();
  updateUI();
  renderQuestion();
}

function pauseTimer(){
  const a = state.attempt;
  if(!a?.timed) return;
  a.timerRunning = false;
  a.pausedByIdle = false;
  saveActiveAttempt();
  updateUI();
}
function resumeTimer(){
  const a = state.attempt;
  if(!a?.timed) return;
  a.timerRunning = true;
  a.pausedByIdle = false;
  state.lastActivityAt = Date.now();
  saveActiveAttempt();
  updateUI();
}

function resetAll(){
  if(!confirm("Reset will clear the active attempt AND attempt history. Continue?")) return;
  localStorage.removeItem(LS.ACTIVE);
  localStorage.removeItem(LS.ATTEMPTS);
  stopTimerLoop();
  stopAutosave();
  state.attempt = null;
  updateUI();
  renderQuestion();
}

/* =========================================================
   WIRE UP
   ========================================================= */
$("modalClose").addEventListener("click", closeModal);
$("modalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="modalBackdrop") closeModal(); });

$("btnAttempts").addEventListener("click", openAttemptsModal);
$("btnReset").addEventListener("click", resetAll);

$("btnStart").addEventListener("click", startNewAttempt);
$("btnResume").addEventListener("click", resumeAttempt);

$("btnPrev").addEventListener("click", goPrev);
$("btnNext").addEventListener("click", goNext);
$("btnFlag").addEventListener("click", toggleFlag);

$("btnSave").addEventListener("click", saveNow);
$("btnSubmit").addEventListener("click", submitAttempt);

$("btnPause").addEventListener("click", pauseTimer);
$("btnResumeTimer").addEventListener("click", resumeTimer);

function toggleSwitch(el){
  el.classList.toggle("on");
  el.setAttribute("aria-checked", el.classList.contains("on") ? "true" : "false");
}

// Timed switch
$("timedSwitch").addEventListener("click", ()=>{
  toggleSwitch($("timedSwitch"));
  const on = $("timedSwitch").classList.contains("on");
  $("durationRow").style.display = on ? "block" : "none";
});

// Mode changes: exam forces 90 min timed
$("modeSelect").addEventListener("change", ()=>{
  const mode = $("modeSelect").value;

  if(mode==="exam"){
    // force timed UI on
    if(!$("timedSwitch").classList.contains("on")){
      $("timedSwitch").classList.add("on");
      $("timedSwitch").setAttribute("aria-checked","true");
    }
    $("durationInput").value = "90";
    $("durationRow").style.display = "block";
  } else {
    // practice: untimed default, duration row only if user turns on timed switch
    const on = $("timedSwitch").classList.contains("on");
    $("durationRow").style.display = on ? "block" : "none";
  }
});

// init
(function init(){
  const saved = loadActiveAttempt();
  $("resumeTag").style.display = saved ? "inline-flex" : "none";
  $("btnResume").style.display = saved ? "inline-block" : "none";

  // default practice untimed
  $("timedSwitch").classList.remove("on");
  $("timedSwitch").setAttribute("aria-checked","false");
  $("durationRow").style.display = "none";
  $("durationInput").value = "90"; // for exam, will be set on mode change

  updateUI();
  renderQuestion();
})();
</script>
</body>
</html>

